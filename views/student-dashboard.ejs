<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Learning Dashboard</title>
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="/css/fontawesome-free-6.7.2-web/css/all.css" />
</head>
<body>
  <!-- NAVBAR -->
  <%- include('partials/navbar') %>
  
  <!-- Hero Section -->
  <section class="dashboard-hero">
    <div class="hero-container">
      <div class="hero-content">
        <div class="hero-welcome">
          <h1 class="hero-title">
            <i class="fas fa-graduation-cap"></i>
            Salom, <%= user.firstName %>!
          </h1>
          <p class="hero-subtitle">O'rganishda davom eting va yangi ko'nikmalarni o'zlashtiring</p>
        </div>
        <div class="hero-stats">
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-book-open"></i>
            </div>
            <div class="stat-info">
              <span class="stat-number"><%= myCourses.length %></span>
              <span class="stat-label">Mening kurslarim</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-play-circle"></i>
            </div>
            <div class="stat-info">
              <span class="stat-number"><%= allCourses.length %></span>
              <span class="stat-label">Mavjud kurslar</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Dashboard Content -->
  <div class="dashboard-main-container">
    <!-- My Courses Section -->
    <section class="dashboard-section">
      <div class="section-header">
        <div class="section-title">
          <i class="fas fa-star"></i>
          <h2>Mening kurslarim</h2>
        </div>
        <p class="section-description">Siz ro'yxatdan o'tgan kurslaringiz</p>
      </div>
      
      <% if (myCourses.length === 0) { %>
        <div class="empty-state">
          <div class="empty-icon">
            <i class="fas fa-book-open"></i>
          </div>
          <h3>Hali kurslarda ro'yxatdan o'tmagansiz</h3>
          <p>O'qishni boshlash uchun quyidagi kurslardan birini tanlang</p>
          <a href="#available-courses" class="cta-button">
            <i class="fas fa-arrow-down"></i>
            Kurslarni ko'rish
          </a>
        </div>
      <% } else { %>
        <div class="courses-grid">
          <% myCourses.forEach(course => { %>
            <div class="course-card enrolled">
              <div class="course-image">
                <img src="<%= course.thumbnailImage %>" alt="<%= course.title %>" />
                <div class="course-overlay">
                  <div class="course-badge enrolled">
                    <i class="fas fa-check-circle"></i>
                    Ro'yxatdan o'tgan
                  </div>
                </div>
              </div>
              <div class="course-content">
                <div class="course-category">
                  <i class="fas fa-tag"></i>
                  <%= course.category %>
                </div>
                <h3 class="course-title"><%= course.title %></h3>
                <p class="course-description"><%= course.description ? course.description.substring(0, 100) + '...' : 'Kurs tavsifi mavjud emas' %></p>
                <div class="course-meta">
                  <span class="meta-item">
                    <i class="fas fa-clock"></i>
                    <%= course.totalHours || 0 %> soat
                  </span>
                  <span class="meta-item">
                    <i class="fas fa-play-circle"></i>
                    <%= course.numberOfLessonsManual || 0 %> dars
                  </span>
                </div>
                <div class="course-actions">
                  <a href="/learning-dashboard?course=<%= course._id %>" class="action-btn primary">
                    <i class="fas fa-play"></i>
                    O'qishni davom ettirish
                  </a>
                </div>
              </div>
            </div>
          <% }) %>
        </div>
      <% } %>
    </section>

    <!-- Available Courses Section -->
    <section class="dashboard-section" id="available-courses">
      <div class="section-header">
        <div class="section-title">
          <i class="fas fa-rocket"></i>
          <h2>Mavjud kurslar</h2>
        </div>
        <p class="section-description">O'qishni boshlash uchun yangi kurslar</p>
      </div>
      
      <div class="courses-grid">
        <% allCourses.forEach(course => {
             const alreadyEnrolled = myCourses.some(c => c._id.toString() === course._id.toString());
        %>
          <div class="course-card <%= alreadyEnrolled ? 'enrolled' : 'available' %>">
            <div class="course-image">
              <img src="<%= course.thumbnailImage %>" alt="<%= course.title %>" />
              <div class="course-overlay">
                <% if (alreadyEnrolled) { %>
                  <div class="course-badge enrolled">
                    <i class="fas fa-check-circle"></i>
                    Ro'yxatdan o'tgan
                  </div>
                <% } else { %>
                  <div class="course-badge new">
                    <i class="fas fa-star"></i>
                    Yangi
                  </div>
                <% } %>
              </div>
            </div>
            <div class="course-content">
              <div class="course-category">
                <i class="fas fa-tag"></i>
                <%= course.category %>
              </div>
              <h3 class="course-title"><%= course.title %></h3>
              <p class="course-description"><%= course.description ? course.description.substring(0, 100) + '...' : 'Kurs tavsifi mavjud emas' %></p>
              <div class="course-meta">
                <span class="meta-item">
                  <i class="fas fa-clock"></i>
                  <%= course.totalHours || 0 %> soat
                </span>
                <span class="meta-item">
                  <i class="fas fa-play-circle"></i>
                  <%= course.numberOfLessonsManual || 0 %> dars
                </span>
                <span class="meta-item price">
                  <i class="fas fa-tag"></i>
                  <%= course.price ? course.price.toLocaleString('ru-RU') + ' so\'m' : 'Bepul' %>
                </span>
              </div>
              <div class="course-actions">
                <% if (alreadyEnrolled) { %>
                  <a href="/learning-dashboard?course=<%= course._id %>" class="action-btn primary">
                    <i class="fas fa-play"></i>
                    O'qishni davom ettirish
                  </a>
                <% } else { %>
                  <button type="button" class="action-btn secondary add-to-cart-btn" 
                    data-course-id="<%= course._id %>" 
                    data-course-title="<%= course.title %>" 
                    data-course-price="<%= course.price %>" 
                    data-course-image="<%= course.thumbnailImage %>">
                    <i class="fas fa-cart-plus"></i>
                    Savatga qo'shish
                  </button>
                <% } %>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    </section>
  </div>
  
  <!-- Contact Sales Modal -->
  <%- include('partials/contact-sales-modal') %>
  
  <!-- Floating Notification -->
  <div id="floatingNotification" class="floating-notification">
    <i class="fas fa-check-circle"></i>
    <span>Kurs savatchaga qo'shildi</span>
  </div>
  
  <%- include('partials/footer') %>
  
  <script>
    // Add to cart functionality for dashboard
    document.addEventListener('DOMContentLoaded', function() {
      const addToCartButtons = document.querySelectorAll('.add-to-cart-btn');
      
      // Function to show floating notification
      function showNotification(message = "Kurs savatchaga qo'shildi") {
        const notification = document.getElementById('floatingNotification');
        if (!notification) {
          console.error('Floating notification element not found');
          return;
        }
        
        const messageSpan = notification.querySelector('span');
        const icon = notification.querySelector('i');
        
        // Update message and icon based on the type
        messageSpan.textContent = message;
        
        if (message.includes('allaqachon')) {
          // Already in cart - show info icon
          icon.className = 'fas fa-info-circle';
          icon.style.color = '#FFA500'; // Orange for info
        } else {
          // Added to cart - show check icon
          icon.className = 'fas fa-check-circle';
          icon.style.color = '#4CAF50'; // Green for success
        }
        
        notification.classList.add('show');
        
        // Hide notification after 2 seconds
        setTimeout(() => {
          notification.classList.remove('show');
        }, 2000);
      }
      
      // Wait for cart functions to be available
      function waitForCartFunctions() {
        return new Promise((resolve) => {
          const checkFunctions = () => {
            if (typeof addToCart === 'function' && typeof getCartItems === 'function') {
              resolve();
            } else {
              setTimeout(checkFunctions, 100);
            }
          };
          checkFunctions();
        });
      }
      
      addToCartButtons.forEach(button => {
        button.addEventListener('click', async function() {
          const courseId = this.getAttribute('data-course-id');
          const courseTitle = this.getAttribute('data-course-title');
          const coursePrice = parseInt(this.getAttribute('data-course-price'));
          const courseImage = this.getAttribute('data-course-image');
          
          // Wait for cart functions to be available
          await waitForCartFunctions();
          
          // Check if addToCart function exists
          if (typeof addToCart === 'function') {
            const wasAdded = addToCart(courseId, courseTitle, coursePrice, courseImage);
            
            if (wasAdded) {
              // Course was added successfully
              showNotification("Kurs savatchaga qo'shildi");
              
              // Show success message on button
              this.innerHTML = '<i class="fas fa-check"></i> Savatga qo\'shildi!';
              this.classList.add('success');
              this.disabled = true;
            } else {
              // Course was already in cart
              showNotification("Kurs allaqachon savatchada, savatchani tekshiring");
            }
          } else {
            console.error('addToCart function not found');
            showNotification("Xatolik yuz berdi, qaytadan urinib ko'ring");
          }
        });
      });
    });
  </script>
</body>
</html> 